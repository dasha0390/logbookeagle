<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Logbook Magang</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      overflow: hidden;
    }

    .header {
      position: relative;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
    }

    .refresh-btn {
      position: absolute;
      right: 15px;
      top: 15px;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 18px;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
    }
    .refresh-btn:hover { background: rgba(255,255,255,0.35); }

    .header h1 { font-size: 24px; margin-bottom: 5px; }
    .header p { font-size: 14px; opacity: 0.9; }

    .content { padding: 30px 20px; }

    .form-group { margin-bottom: 20px; }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }
    .required { color: #e74c3c; }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
    }
    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .form-group textarea { resize: vertical; min-height: 90px; }

    .btn {
      width: 100%;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 10px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    .btn-secondary {
      background: #667eea;
      color: white;
      font-family: 'Poppins', sans-serif;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .alert {
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

    .hidden { display: none; }

    .user-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .user-info span { font-weight: 600; color: #667eea; }

    .loading { text-align: center; padding: 20px; color: #667eea; }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }
    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      color: #666;
      transition: all 0.3s;
      user-select: none;
    }
    .tab.active {
      color: #667eea;
      border-bottom: 3px solid #667eea;
      margin-bottom: -2px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } }

    .file-upload {
      border: 2px dashed #e0e0e0;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      user-select: none;
    }
    .file-upload:hover { border-color: #667eea; background: #f8f9fa; }
    .file-upload input[type="file"] { display: none; }
    .file-name { margin-top: 10px; font-size: 14px; color: #667eea; }

    .logbook-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
      position: relative;
    }
    .logbook-item h3 {
      color: #667eea;
      font-size: 16px;
      margin-bottom: 8px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .logbook-item p { color: #666; font-size: 14px; margin-bottom: 5px; }
    .logbook-item .date { color: #999; font-size: 12px; }

    .logbook-actions { display: flex; gap: 8px; margin-top: 12px; margin-bottom: 8px; }
    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      user-select: none;
    }
    .btn-edit { background: #3498db; color: white; }
    .btn-edit:hover { background: #2980b9; }
    .btn-delete { background: #e74c3c; color: white; }
    .btn-delete:hover { background: #c0392b; }

    .logbook-image {
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
      max-width: 100%;
    }
    .logbook-image img {
      width: 100%;
      height: auto;
      display: block;
      cursor: pointer;
      transition: transform 0.3s;
    }
    .logbook-image img:hover { transform: scale(1.02); }
    .image-placeholder {
      width: 100%;
      height: 200px;
      background: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      color: #999;
      font-size: 14px;
    }

    .image-modal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.9);
      animation: fadeIn 0.3s;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .image-modal-content {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90%;
      max-height: 90%;
    }
    .image-modal-content img { width: 100%; height: auto; border-radius: 10px; }
    .image-modal-close {
      position: absolute;
      top: 20px; right: 30px;
      color: white;
      font-size: 40px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10000;
    }
    .image-modal-close:hover { color: #667eea; }

    .file-link {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 12px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      font-size: 12px;
    }
    .file-link:hover { background: #5568d3; }

    .student-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 4px solid #667eea;
      user-select: none;
    }
    .student-card:hover {
      transform: translateX(5px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    .student-card h3 { color: #667eea; font-size: 16px; margin-bottom: 5px; }
    .student-card p { color: #666; font-size: 13px; }

    .profile-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
      text-align: center;
    }
    .profile-card h2 { font-size: 20px; margin-bottom: 5px; }
    .profile-card p { font-size: 14px; opacity: 0.9; }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .info-item {
      background: white;
      padding: 10px;
      border-radius: 8px;
    }
    .info-item label {
      font-size: 11px;
      color: #999;
      display: block;
      margin-bottom: 5px;
    }
    .info-item span {
      font-size: 13px;
      color: #333;
      font-weight: 600;
      word-wrap: break-word;
      overflow-wrap: break-word;
      display: block;
    }
    .info-item.full-width { grid-column: 1 / -1; }
    @media (max-width: 600px) {
      .info-grid { grid-template-columns: 1fr; gap: 8px; }
      .info-item { padding: 12px; }
      .info-item label { font-size: 12px; }
      .info-item span { font-size: 14px; }
    }

    .hint { font-size: 12px; color: #777; margin-top: 6px; }

    /* Global Loading Overlay */
    #globalLoading {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.75);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-weight: 700;
      font-size: 18px;
    }
    #globalLoading .box {
      background: white;
      border-radius: 14px;
      padding: 18px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.12);
      min-width: 240px;
    }
    #globalLoading .small {
      margin-top: 8px;
      font-weight: 600;
      font-size: 12px;
      color: #666;
    }
  </style>
</head>

<body>
  <div class="container">
    <!-- LOGIN -->
    <div id="loginPage">
      <div class="header">
        <button class="refresh-btn" onclick="refreshCurrentPage()" title="Refresh data">üîÑ</button>
        <img src="eagle.png" width="60" />
        <h1>Logbook Magang</h1>
        <p>Sistem Pencatatan Kegiatan Magang</p>
      </div>

      <div class="content">
        <div id="loginAlert"></div>

        <form id="loginForm">
          <div class="form-group">
            <label>Username <span class="required">*</span></label>
            <input type="text" id="username" required placeholder="Masukkan username" />
          </div>

          <div class="form-group">
            <label>Password <span class="required">*</span></label>
            <input type="password" id="password" required placeholder="Masukkan password" />
          </div>

          <div class="form-group" style="margin-bottom: 10px;">
            <label style="display:flex; align-items:center; cursor:pointer; font-weight: normal;">
              <input type="checkbox" id="rememberMe" style="width:auto; margin-right:8px;" />
              <span style="font-size:14px;">Ingat saya</span>
            </label>
            <div class="hint">Jika dicentang, login akan tersimpan walau halaman di-refresh.</div>
          </div>

          <button type="submit" class="btn btn-primary" id="loginBtn">Masuk</button>
        </form>
      </div>
    </div>

    <!-- SISWA -->
    <div id="studentPage" class="hidden">
      <div class="header">
        <button class="refresh-btn" onclick="refreshCurrentPage()" title="Refresh data">üîÑ</button>
        <img src="eagle.png" width="60" />
        <h1>Logbook Saya</h1>
        <p>Catat kegiatan magang harian Anda</p>
      </div>

      <div class="content">
        <div class="user-info">
          <span id="studentName">Siswa</span>
          <div style="display:flex; gap:8px;">
            <button class="btn-secondary" onclick="refreshCurrentPage()" style="padding: 8px 12px; width:auto; border-radius: 6px;">üîÑ Refresh</button>
            <button class="btn-secondary" onclick="logout()" style="padding: 8px 12px; width:auto; border-radius: 6px;">Keluar</button>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" onclick="showStudentTab('profil')">üë§ Profil</div>
          <div class="tab" onclick="showStudentTab('add')">‚ûï Tambah</div>
          <div class="tab" onclick="showStudentTab('view')">üìã Lihat</div>
        </div>

        <!-- TAB PROFIL -->
        <div id="profilTab">
          <div id="profilAlert"></div>

          <form id="profilForm">
            <div class="form-group">
              <label>Nama Lengkap <span class="required">*</span></label>
              <input type="text" id="namaLengkap" required placeholder="Nama lengkap" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>No Absen <span class="required">*</span></label>
                <input type="text" id="noAbsen" required placeholder="Nomor absen" />
              </div>
              <div class="form-group">
                <label>Telepon <span class="required">*</span></label>
                <input type="tel" id="telepon" required placeholder="Nomor telepon" />
              </div>
            </div>

            <div class="form-group">
              <label>Email <span class="required">*</span></label>
              <input type="email" id="email" required placeholder="Email" />
            </div>

            <div class="form-group">
              <label>Tempat Magang <span class="required">*</span></label>
              <input type="text" id="tempatMagang" required placeholder="Nama perusahaan/instansi" />
            </div>

            <div class="form-group">
              <label>Alamat Tempat Magang <span class="required">*</span></label>
              <textarea id="alamatMagang" required placeholder="Alamat lengkap tempat magang"></textarea>
            </div>

            <div class="form-group">
              <label>Posisi Magang <span class="required">*</span></label>
              <input type="text" id="posisi" required placeholder="Contoh: Web Developer, Designer" />
            </div>

            <div class="form-group">
              <label>Nama Pembimbing</label>
              <input type="text" id="pembimbing" placeholder="Nama pembimbing di tempat magang" />
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Tanggal Mulai <span class="required">*</span></label>
                <input type="date" id="tanggalMulai" required />
              </div>
              <div class="form-group">
                <label>Tanggal Selesai <span class="required">*</span></label>
                <input type="date" id="tanggalSelesai" required />
              </div>
            </div>

            <button type="submit" class="btn btn-primary" id="saveProfilBtn">üíæ Simpan Profil</button>
          </form>
        </div>

        <!-- TAB TAMBAH -->
        <div id="addTab" class="hidden">
          <div id="studentAlert"></div>

          <form id="logbookForm">
            <div class="form-group">
              <label>Tanggal <span class="required">*</span></label>
              <input type="date" id="tanggal" required />
            </div>

            <div class="form-group">
              <label>Judul Kegiatan <span class="required">*</span></label>
              <input type="text" id="judul" required placeholder="Contoh: Membuat video promosi" />
            </div>

            <div class="form-group">
              <label>Deskripsi <span class="required">*</span></label>
              <textarea id="deskripsi" required placeholder="Jelaskan kegiatan yang dilakukan"></textarea>
            </div>

            <div class="form-group">
              <label>Upload Foto (Opsional)</label>
              <div class="file-upload" onclick="openFilePicker()">
                <p>üì∑ Klik untuk pilih foto / buka kamera</p>
                <p style="font-size:12px; color:#999;">Otomatis dikompres sampai max 2MB</p>

                <input type="file" id="fileInput" accept="image/*" capture="environment" />
                <div id="fileName" class="file-name"></div>
              </div>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">Simpan Logbook</button>
            <button type="button" class="btn btn-secondary hidden" id="cancelBtn" onclick="cancelEdit()">Batal Edit</button>
          </form>
        </div>

        <!-- TAB LIHAT -->
        <div id="viewTab" class="hidden">
          <div id="logbookList" class="loading">Memuat data...</div>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div id="adminPage" class="hidden">
      <div class="header">
        <button class="refresh-btn" onclick="refreshCurrentPage()" title="Refresh data">üîÑ</button>
        <img src="eagle.png" width="60" />
        <h1>Dashboard Admin</h1>
        <p>Kelola dan pantau logbook siswa</p>
      </div>

      <div class="content">
        <div class="user-info">
          <span>Administrator</span>
          <div style="display:flex; gap:8px;">
            <button class="btn-secondary" onclick="refreshCurrentPage()" style="padding: 8px 12px; width:auto; border-radius: 6px;">üîÑ Refresh</button>
            <button class="btn-secondary" onclick="logout()" style="padding: 8px 12px; width:auto; border-radius: 6px;">Keluar</button>
          </div>
        </div>

        <div id="adminAlert"></div>
        <div id="studentsList"></div>
      </div>
    </div>

    <!-- DETAIL SISWA (ADMIN) -->
    <div id="studentDetailPage" class="hidden">
      <div class="header">
        <button class="refresh-btn" onclick="refreshCurrentPage()" title="Refresh data">üîÑ</button>
        <img src="eagle.png" width="60" />
        <h1 id="detailStudentName">Detail Siswa</h1>
        <p>Profil dan Logbook</p>
      </div>

      <div class="content">
        <div style="display:flex; gap:8px; margin-bottom: 20px;">
          <button class="btn btn-secondary" onclick="backToAdmin()" style="margin:0;">‚Üê Kembali</button>
          <button class="btn btn-secondary" onclick="refreshCurrentPage()" style="margin:0;">üîÑ Refresh</button>
        </div>

        <div class="tabs">
          <div class="tab active" onclick="showDetailTab('profil')">üë§ Profil</div>
          <div class="tab" onclick="showDetailTab('logbook')">üìã Logbook</div>
        </div>

        <div id="detailProfilTab">
          <div id="studentProfileDisplay" class="loading">Memuat profil...</div>
        </div>

        <div id="detailLogbookTab" class="hidden">
          <div id="adminLogbookList" class="loading">Memuat logbook...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL ZOOM GAMBAR -->
  <div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <div class="image-modal-content">
      <img id="modalImage" src="" alt="Preview" />
    </div>
  </div>

  <!-- GLOBAL LOADING OVERLAY -->
  <div id="globalLoading">
    <div class="box">
      üîÑ Memperbarui data...
      <div class="small">Mohon tunggu sebentar</div>
    </div>
  </div>

  <script>
    // =========================
    // WAJIB: GANTI URL WEB APP
    // =========================
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwG073ZtSzl3p72c869I3JSRTVgrX4uWVVEozKOj4jlkAlEaXiB-Q4xhE3meTay8o2Drw/exec";

    let currentUser = null;
    let currentRole = null;
    let editingLogbookNo = null;
    let selectedStudent = null;

    document.addEventListener('DOMContentLoaded', async function () {
      const today = new Date().toISOString().split('T')[0];
      const tanggalInput = document.getElementById('tanggal');
      if (tanggalInput) tanggalInput.value = today;

      // Auto-login jika remember me aktif
      const remember = localStorage.getItem('logbook_remember') === '1';
      if (remember) {
        const u = localStorage.getItem('logbook_username');
        const p = localStorage.getItem('logbook_password');
        if (u && p) {
          try {
            showGlobalLoading(true, 'üîÑ Memulihkan sesi login...');
            const response = await fetch(`${SCRIPT_URL}?action=login&username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`);
            const data = await response.json();

            if (data.success) {
              currentUser = data.user;
              currentRole = data.role;

              document.getElementById('loginPage').classList.add('hidden');

              if (data.role === 'admin') {
                document.getElementById('adminPage').classList.remove('hidden');
                await loadStudentsForAdmin();
              } else {
                document.getElementById('studentPage').classList.remove('hidden');
                document.getElementById('studentName').textContent = data.nama;
                await loadProfile();
                showStudentTab('profil');
              }
            }
          } catch (e) {
            // biarkan di login page
          } finally {
            showGlobalLoading(false);
          }
        }
      }
    });

    // =========================
    // ADVANCE REFRESH (NO RELOAD)
    // =========================
    async function refreshCurrentPage() {
      try {
        showGlobalLoading(true, 'üîÑ Memperbarui data...');

        // LOGIN PAGE
        if (!currentUser) {
          document.getElementById('loginForm').reset();
          showAlert('loginAlert', 'üîÑ Halaman login diperbarui', 'info');
          return;
        }

        // SISWA
        if (currentRole === 'siswa') {
          const profilVisible = !document.getElementById('profilTab').classList.contains('hidden');
          const viewVisible = !document.getElementById('viewTab').classList.contains('hidden');

          if (profilVisible) {
            await loadProfile();
            showAlert('profilAlert', 'üîÑ Profil diperbarui', 'info');
          } else if (viewVisible) {
            await loadMyLogbook();
            showAlert('studentAlert', 'üîÑ Logbook diperbarui', 'info');
          } else {
            // add tab: refresh both silently
            await loadProfile();
            await loadMyLogbook();
            showAlert('studentAlert', 'üîÑ Data diperbarui', 'info');
          }
          return;
        }

        // ADMIN
        if (currentRole === 'admin') {
          const adminVisible = !document.getElementById('adminPage').classList.contains('hidden');
          const detailVisible = !document.getElementById('studentDetailPage').classList.contains('hidden');

          if (adminVisible) {
            await loadStudentsForAdmin();
            showAlert('adminAlert', 'üîÑ Daftar siswa diperbarui', 'info');
          } else if (detailVisible && selectedStudent) {
            const detailProfilVisible = !document.getElementById('detailProfilTab').classList.contains('hidden');
            const detailLogbookVisible = !document.getElementById('detailLogbookTab').classList.contains('hidden');

            if (detailProfilVisible) {
              await loadStudentProfile(selectedStudent);
            } else if (detailLogbookVisible) {
              await loadStudentLogbook(selectedStudent);
            } else {
              await loadStudentProfile(selectedStudent);
              await loadStudentLogbook(selectedStudent);
            }
          }
          return;
        }

      } catch (err) {
        alert('Gagal refresh: ' + err.message);
      } finally {
        showGlobalLoading(false);
      }
    }

    function showGlobalLoading(show, text) {
      const el = document.getElementById('globalLoading');
      if (text) {
        const box = el.querySelector('.box');
        if (box) box.childNodes[0].textContent = text;
      }
      el.style.display = show ? 'flex' : 'none';
    }

    // ========================================
    // LOGIN
    // ========================================
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const loginBtn = document.getElementById('loginBtn');

      loginBtn.disabled = true;
      loginBtn.textContent = 'Memproses...';

      try {
        showGlobalLoading(true, 'üîÑ Memproses login...');
        const response = await fetch(`${SCRIPT_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
        const data = await response.json();

        if (data.success) {
          currentUser = data.user;
          currentRole = data.role;

          const remember = document.getElementById('rememberMe').checked;
          if (remember) {
            localStorage.setItem('logbook_remember', '1');
            localStorage.setItem('logbook_username', username);
            localStorage.setItem('logbook_password', password);
          } else {
            localStorage.removeItem('logbook_remember');
            localStorage.removeItem('logbook_username');
            localStorage.removeItem('logbook_password');
          }

          document.getElementById('loginPage').classList.add('hidden');

          if (data.role === 'admin') {
            document.getElementById('adminPage').classList.remove('hidden');
            await loadStudentsForAdmin();
          } else {
            document.getElementById('studentPage').classList.remove('hidden');
            document.getElementById('studentName').textContent = data.nama;
            await loadProfile();
            showStudentTab('profil');
          }
        } else {
          showAlert('loginAlert', data.message || 'Login gagal', 'error');
        }
      } catch (error) {
        showAlert('loginAlert', 'Gagal login: ' + error.message, 'error');
      } finally {
        showGlobalLoading(false);
        loginBtn.disabled = false;
        loginBtn.textContent = 'Masuk';
      }
    });

    // ========================================
    // PROFIL
    // ========================================
    async function loadProfile() {
      const response = await fetch(`${SCRIPT_URL}?action=getProfile&username=${encodeURIComponent(currentUser)}`);
      const data = await response.json();

      if (data.success && data.profile) {
        const p = data.profile;
        document.getElementById('namaLengkap').value = p.namaLengkap || '';
        document.getElementById('noAbsen').value = p.noAbsen || '';
        document.getElementById('email').value = p.email || '';
        document.getElementById('telepon').value = p.telepon || '';
        document.getElementById('tempatMagang').value = p.tempatMagang || '';
        document.getElementById('alamatMagang').value = p.alamatMagang || '';
        document.getElementById('posisi').value = p.posisi || '';
        document.getElementById('pembimbing').value = p.pembimbing || '';
        document.getElementById('tanggalMulai').value = convertDateToInput(p.tanggalMulai) || '';
        document.getElementById('tanggalSelesai').value = convertDateToInput(p.tanggalSelesai) || '';
      }
    }

    document.getElementById('profilForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const saveBtn = document.getElementById('saveProfilBtn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'üíæ Menyimpan...';

      try {
        showGlobalLoading(true, 'üîÑ Menyimpan profil...');
        const payload = {
          action: 'saveProfile',
          username: currentUser,
          namaLengkap: document.getElementById('namaLengkap').value,
          noAbsen: document.getElementById('noAbsen').value,
          email: document.getElementById('email').value,
          telepon: document.getElementById('telepon').value,
          tempatMagang: document.getElementById('tempatMagang').value,
          alamatMagang: document.getElementById('alamatMagang').value,
          posisi: document.getElementById('posisi').value,
          pembimbing: document.getElementById('pembimbing').value,
          tanggalMulai: document.getElementById('tanggalMulai').value,
          tanggalSelesai: document.getElementById('tanggalSelesai').value
        };

        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await response.json();

        if (data.success) showAlert('profilAlert', '‚úÖ Profil berhasil disimpan!', 'success');
        else showAlert('profilAlert', '‚ùå ' + (data.message || 'Gagal menyimpan'), 'error');
      } catch (error) {
        showAlert('profilAlert', '‚ùå Gagal menyimpan: ' + error.message, 'error');
      } finally {
        showGlobalLoading(false);
        saveBtn.disabled = false;
        saveBtn.textContent = 'üíæ Simpan Profil';
      }
    });

    // ========================================
    // LOGBOOK
    // ========================================
    document.getElementById('logbookForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;

      const isEditing = editingLogbookNo !== null;
      submitBtn.textContent = isEditing ? 'Mengupdate...' : 'Menyimpan...';

      const tanggal = document.getElementById('tanggal').value;
      const judul = document.getElementById('judul').value;
      const deskripsi = document.getElementById('deskripsi').value;
      const fileInput = document.getElementById('fileInput');

      let fileData = '';
      let fileName = '';

      try {
        showGlobalLoading(true, isEditing ? 'üîÑ Mengupdate logbook...' : 'üîÑ Menyimpan logbook...');

        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          fileName = file.name;
          fileData = await compressImageToDataURL(file, 2 * 1024 * 1024);
        }

        const payload = {
          action: isEditing ? 'updateLogbook' : 'addLogbook',
          username: currentUser,
          tanggal,
          judul,
          deskripsi,
          fileData,
          fileName
        };
        if (isEditing) payload.no = editingLogbookNo;

        const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
        const data = await response.json();

        if (data.success) {
          showAlert('studentAlert', isEditing ? '‚úÖ Logbook berhasil diupdate!' : '‚úÖ Logbook berhasil disimpan!', 'success');
          document.getElementById('logbookForm').reset();
          document.getElementById('fileName').textContent = '';
          document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
          editingLogbookNo = null;

          submitBtn.textContent = 'Simpan Logbook';
          submitBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          document.getElementById('cancelBtn').classList.add('hidden');

          // refresh view data tanpa reload halaman
          await loadMyLogbook();
        } else {
          showAlert('studentAlert', '‚ùå ' + (data.message || 'Gagal menyimpan'), 'error');
        }
      } catch (error) {
        showAlert('studentAlert', '‚ùå Gagal menyimpan: ' + error.message, 'error');
      } finally {
        showGlobalLoading(false);
        submitBtn.disabled = false;
        if (!isEditing) submitBtn.textContent = 'Simpan Logbook';
      }
    });

    async function loadMyLogbook() {
      const listDiv = document.getElementById('logbookList');
      listDiv.innerHTML = '<div class="loading">Memuat data...</div>';

      const response = await fetch(`${SCRIPT_URL}?action=getLogbook&username=${encodeURIComponent(currentUser)}`);
      const data = await response.json();

      if (data.success && data.logbook && data.logbook.length > 0) {
        listDiv.innerHTML = data.logbook.map(log => {
          let imageHtml = '';

          if (log.fileId) {
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${log.fileId}&sz=w400`;
            const fullImageUrl = `https://drive.google.com/uc?id=${log.fileId}`;
            imageHtml = `
              <div class="logbook-image">
                <img src="${thumbnailUrl}"
                     alt="Foto kegiatan"
                     onclick="openImageModal('${fullImageUrl}')"
                     onerror="this.parentElement.innerHTML='<div class=image-placeholder>üì∑ Foto tidak dapat dimuat</div>'">
              </div>
            `;
          } else if (log.berkas && String(log.berkas).includes('drive.google.com')) {
            imageHtml = `<a href="${log.berkas}" target="_blank" class="file-link">üì∑ Lihat Foto</a>`;
          }

          return `
            <div class="logbook-item">
              <div class="logbook-actions">
                <button class="btn-action btn-edit"
                  onclick="editLogbook(${log.no}, '${escapeHtml(log.tanggal)}', '${escapeHtml(log.judul)}', '${escapeHtml(log.deskripsi)}')">‚úèÔ∏è Edit</button>
                <button class="btn-action btn-delete" onclick="deleteLogbook(${log.no})">üóëÔ∏è Hapus</button>
              </div>
              <h3>${escapeHtml(log.judul || '')}</h3>
              <p>${escapeHtml(log.deskripsi || '')}</p>
              <p class="date">üìÖ ${escapeHtml(log.tanggal || '')}</p>
              ${imageHtml}
            </div>
          `;
        }).join('');
      } else {
        listDiv.innerHTML = '<div class="alert alert-info">Belum ada logbook. Mulai tambahkan kegiatan Anda!</div>';
      }
    }

    function editLogbook(no, tanggal, judul, deskripsi) {
      editingLogbookNo = no;

      const dateParts = String(tanggal).split('/');
      const formattedDate = dateParts.length === 3 ? `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}` : tanggal;

      document.getElementById('tanggal').value = formattedDate;
      document.getElementById('judul').value = judul;
      document.getElementById('deskripsi').value = deskripsi;

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.textContent = 'Update Logbook';
      submitBtn.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';

      document.getElementById('cancelBtn').classList.remove('hidden');

      showStudentTab('add');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showAlert('studentAlert', 'üìù Mode edit: Ubah data lalu klik "Update Logbook"', 'info');
    }

    function cancelEdit() {
      editingLogbookNo = null;
      document.getElementById('logbookForm').reset();
      document.getElementById('fileName').textContent = '';
      document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];

      const submitBtn = document.getElementById('submitBtn');
      submitBtn.textContent = 'Simpan Logbook';
      submitBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';

      document.getElementById('cancelBtn').classList.add('hidden');
      document.getElementById('studentAlert').innerHTML = '';
    }

    async function deleteLogbook(no) {
      if (!confirm('Apakah Anda yakin ingin menghapus logbook ini?')) return;

      try {
        showGlobalLoading(true, 'üîÑ Menghapus logbook...');
        const response = await fetch(`${SCRIPT_URL}?action=deleteLogbook&username=${encodeURIComponent(currentUser)}&no=${encodeURIComponent(no)}`);
        const data = await response.json();

        if (data.success) {
          showAlert('studentAlert', '‚úÖ Logbook berhasil dihapus!', 'success');
          await loadMyLogbook();
        } else {
          showAlert('studentAlert', '‚ùå ' + (data.message || 'Gagal menghapus'), 'error');
        }
      } catch (error) {
        showAlert('studentAlert', '‚ùå Gagal menghapus: ' + error.message, 'error');
      } finally {
        showGlobalLoading(false);
      }
    }

    // ========================================
    // ADMIN
    // ========================================
    async function loadStudentsForAdmin() {
      const listDiv = document.getElementById('studentsList');
      listDiv.innerHTML = '<div class="loading">Memuat daftar siswa...</div>';

      const response = await fetch(`${SCRIPT_URL}?action=getStudents`);
      const data = await response.json();

      if (data.success && data.students && data.students.length > 0) {
        listDiv.innerHTML = data.students.map(student => `
          <div class="student-card" onclick="viewStudentDetail('${escapeHtml(student.username)}', '${escapeHtml(student.nama)}')">
            <h3>üë§ ${escapeHtml(student.nama)}</h3>
            <p>Username: ${escapeHtml(student.username)}</p>
            <p style="font-size:12px; margin-top:8px; color:#667eea;">Klik untuk melihat detail ‚Üí</p>
          </div>
        `).join('');
      } else {
        listDiv.innerHTML = '<div class="alert alert-info">Belum ada siswa terdaftar.</div>';
      }
    }

    async function viewStudentDetail(username, nama) {
      selectedStudent = username;
      document.getElementById('detailStudentName').textContent = nama;

      document.getElementById('adminPage').classList.add('hidden');
      document.getElementById('studentDetailPage').classList.remove('hidden');

      await showDetailTab('profil');
    }

    function backToAdmin() {
      document.getElementById('studentDetailPage').classList.add('hidden');
      document.getElementById('adminPage').classList.remove('hidden');
      selectedStudent = null;
    }

    async function showDetailTab(tab) {
      document.querySelectorAll('#studentDetailPage .tab').forEach(t => t.classList.remove('active'));

      if (tab === 'profil') {
        document.querySelectorAll('#studentDetailPage .tab')[0].classList.add('active');
        document.getElementById('detailProfilTab').classList.remove('hidden');
        document.getElementById('detailLogbookTab').classList.add('hidden');
        await loadStudentProfile(selectedStudent);
      } else {
        document.querySelectorAll('#studentDetailPage .tab')[1].classList.add('active');
        document.getElementById('detailProfilTab').classList.add('hidden');
        document.getElementById('detailLogbookTab').classList.remove('hidden');
        await loadStudentLogbook(selectedStudent);
      }
    }

    async function loadStudentProfile(username) {
      const displayDiv = document.getElementById('studentProfileDisplay');
      displayDiv.innerHTML = '<div class="loading">Memuat profil...</div>';

      const response = await fetch(`${SCRIPT_URL}?action=getProfile&username=${encodeURIComponent(username)}`);
      const data = await response.json();

      if (data.success && data.profile) {
        const p = data.profile;
        const hasData = p.namaLengkap || p.tempatMagang || p.noAbsen;

        if (!hasData) {
          displayDiv.innerHTML = '<div class="alert alert-info">Siswa belum melengkapi profil.</div>';
          return;
        }

        displayDiv.innerHTML = `
          <div class="profile-card">
            <h2>${escapeHtml(p.namaLengkap || '-')}</h2>
            <p>No Absen: ${escapeHtml(p.noAbsen || '-')}</p>
          </div>

          <div class="info-grid">
            <div class="info-item full-width">
              <label>Email</label>
              <span>${escapeHtml(p.email || '-')}</span>
            </div>
            <div class="info-item full-width">
              <label>Telepon</label>
              <span>${escapeHtml(p.telepon || '-')}</span>
            </div>
            <div class="info-item full-width">
              <label>Tempat Magang</label>
              <span>${escapeHtml(p.tempatMagang || '-')}</span>
            </div>
            <div class="info-item full-width">
              <label>Alamat Tempat Magang</label>
              <span>${escapeHtml(p.alamatMagang || '-')}</span>
            </div>
            <div class="info-item full-width">
              <label>Posisi</label>
              <span>${escapeHtml(p.posisi || '-')}</span>
            </div>
            <div class="info-item full-width">
              <label>Pembimbing</label>
              <span>${escapeHtml(p.pembimbing || '-')}</span>
            </div>
            <div class="info-item">
              <label>Tanggal Mulai</label>
              <span>${escapeHtml(p.tanggalMulai || '-')}</span>
            </div>
            <div class="info-item">
              <label>Tanggal Selesai</label>
              <span>${escapeHtml(p.tanggalSelesai || '-')}</span>
            </div>
          </div>
        `;
      } else {
        displayDiv.innerHTML = '<div class="alert alert-error">Profil tidak ditemukan.</div>';
      }
    }

    async function loadStudentLogbook(username) {
      const listDiv = document.getElementById('adminLogbookList');
      listDiv.innerHTML = '<div class="loading">Memuat logbook...</div>';

      const response = await fetch(`${SCRIPT_URL}?action=getLogbook&username=${encodeURIComponent(username)}`);
      const data = await response.json();

      if (data.success && data.logbook && data.logbook.length > 0) {
        listDiv.innerHTML = data.logbook.map(log => {
          let imageHtml = '';

          if (log.fileId) {
            const thumbnailUrl = `https://drive.google.com/thumbnail?id=${log.fileId}&sz=w400`;
            imageHtml = `
              <div class="logbook-image">
                <img src="${thumbnailUrl}"
                     alt="Foto kegiatan"
                     onclick="window.open('https://drive.google.com/file/d/${log.fileId}/view', '_blank')"
                     onerror="this.parentElement.innerHTML='<div class=image-placeholder>üì∑ Foto tidak dapat dimuat</div>'">
              </div>
            `;
          } else if (log.berkas && String(log.berkas).includes('drive.google.com')) {
            imageHtml = `<a href="${log.berkas}" target="_blank" class="file-link">üì∑ Lihat Foto</a>`;
          }

          return `
            <div class="logbook-item">
              <h3>${escapeHtml(log.judul || '')}</h3>
              <p>${escapeHtml(log.deskripsi || '')}</p>
              <p class="date">üìÖ ${escapeHtml(log.tanggal || '')}</p>
              ${imageHtml}
            </div>
          `;
        }).join('');
      } else {
        listDiv.innerHTML = '<div class="alert alert-info">Belum ada logbook untuk siswa ini.</div>';
      }
    }

    // ========================================
    // UI NAV
    // ========================================
    function showStudentTab(tab) {
      document.querySelectorAll('#studentPage .tab').forEach(t => t.classList.remove('active'));
      const tabs = document.querySelectorAll('#studentPage .tab');

      if (tab === 'profil') {
        tabs[0].classList.add('active');
        document.getElementById('profilTab').classList.remove('hidden');
        document.getElementById('addTab').classList.add('hidden');
        document.getElementById('viewTab').classList.add('hidden');

      } else if (tab === 'add') {
        tabs[1].classList.add('active');
        document.getElementById('profilTab').classList.add('hidden');
        document.getElementById('addTab').classList.remove('hidden');
        document.getElementById('viewTab').classList.add('hidden');

      } else {
        tabs[2].classList.add('active');
        document.getElementById('profilTab').classList.add('hidden');
        document.getElementById('addTab').classList.add('hidden');
        document.getElementById('viewTab').classList.remove('hidden');

        // reset mode edit saat pindah ke view
        editingLogbookNo = null;
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.textContent = 'Simpan Logbook';
        submitBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        document.getElementById('cancelBtn').classList.add('hidden');

        document.getElementById('logbookForm').reset();
        document.getElementById('fileName').textContent = '';
        document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];

        loadMyLogbook();
      }
    }

    function showAlert(elementId, message, type) {
      const alertDiv = document.getElementById(elementId);
      if (!alertDiv) return;
      alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => (alertDiv.innerHTML = ''), 5000);
    }

    function escapeHtml(text) {
      const s = String(text ?? '');
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;', '\n': ' ', '\r': '' };
      return s.replace(/[&<>"'\n\r]/g, m => map[m]);
    }

    function convertDateToInput(dateStr) {
      if (!dateStr) return '';
      const parts = String(dateStr).split('/');
      if (parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
      return dateStr;
    }

    function openFilePicker() { document.getElementById('fileInput').click(); }

    document.getElementById('fileInput').addEventListener('change', function () {
      const fileName = this.files[0] ? this.files[0].name : '';
      document.getElementById('fileName').textContent = fileName ? `‚úì ${fileName}` : '';
    });

    function logout() {
      currentUser = null;
      currentRole = null;
      selectedStudent = null;
      editingLogbookNo = null;

      // NOTE: supaya refresh tidak logout, remember me tidak dihapus di sini.
      // Jika ingin logout total, uncomment:
      // localStorage.removeItem('logbook_remember');
      // localStorage.removeItem('logbook_username');
      // localStorage.removeItem('logbook_password');

      document.getElementById('loginPage').classList.remove('hidden');
      document.getElementById('studentPage').classList.add('hidden');
      document.getElementById('adminPage').classList.add('hidden');
      document.getElementById('studentDetailPage').classList.add('hidden');
      document.getElementById('loginForm').reset();
    }

    function openImageModal(imageUrl) {
      const modal = document.getElementById('imageModal');
      const modalImg = document.getElementById('modalImage');
      modal.style.display = 'block';
      modalImg.src = imageUrl;
    }
    function closeImageModal() { document.getElementById('imageModal').style.display = 'none'; }
    document.addEventListener('keydown', function (event) { if (event.key === 'Escape') closeImageModal(); });

    // ========================================
    // AUTO KOMPRES FOTO MAX 2MB
    // ========================================
    async function compressImageToDataURL(file, maxBytes = 2 * 1024 * 1024) {
      const bitmap = await createImageBitmap(file);

      let quality = 0.86;
      let scale = 1.0;

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const encode = () => {
        canvas.width = Math.max(1, Math.round(bitmap.width * scale));
        canvas.height = Math.max(1, Math.round(bitmap.height * scale));
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(bitmap, 0, 0, canvas.width, canvas.height);
        return canvas.toDataURL('image/jpeg', quality);
      };

      for (let i = 0; i < 12; i++) {
        const dataUrl = encode();
        const base64 = dataUrl.split(',')[1] || '';
        const approxBytes = Math.floor(base64.length * 0.75);

        if (approxBytes <= maxBytes) return dataUrl;

        if (quality > 0.5) quality -= 0.08;
        else scale -= 0.12;

        if (scale < 0.3) break;
      }

      throw new Error('Gambar terlalu besar walau sudah dikompres. Coba foto lain.');
    }
  </script>
</body>
</html>
